# Carte Planificateur de Charge BMW iX3
# N√©cessite : card-mod + mushroom (HACS)

type: vertical-stack
cards:
  # En-t√™te
  - type: custom:mushroom-template-card
    primary: üïê Planificateur de Charge BMW iX3
    secondary: |
      D√©part √† {{ states('number.bmw_ix3_departure_time') or '08:00' }}h | 
      SOC Cible : {{ states('sensor.target_state_of_charge') or '80' }}%
    icon: mdi:calendar-clock
    icon_color: purple
    layout: horizontal
    card_mod:
      style: |
        ha-card {
          background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
          color: white;
        }
  
  # Configuration rapide
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-template-card
        entity: number.bmw_ix3_departure_time
        icon: mdi:clock-outline
        icon_color: purple
        primary: Heure de D√©part
        secondary: '{{ states("number.bmw_ix3_departure_time") or "08:00" }}h'
        tap_action:
          action: more-info
          entity: number.bmw_ix3_departure_time
        card_mod:
          style: |
            ha-card {
              background: rgba(156, 39, 176, 0.1);
              backdrop-filter: blur(10px);
            }
      - type: custom:mushroom-template-card
        entity: sensor.target_state_of_charge
        icon: mdi:battery-charging
        icon_color: orange
        primary: SOC Cible
        secondary: '{{ states("sensor.target_state_of_charge") or "80" }}%'
        tap_action:
          action: more-info
          entity: sensor.target_state_of_charge
        card_mod:
          style: |
            ha-card {
              background: rgba(255, 193, 7, 0.1);
              backdrop-filter: blur(10px);
            }
  
  # Calculs de planification
  - type: markdown
    content: |
      ## ‚è∞ Planification de Charge
      
      ### üéØ Objectif
      - **D√©part pr√©vu** : {{ states('number.bmw_ix3_departure_time') or '08:00' }}h
      - **SOC cible** : {{ states('sensor.target_state_of_charge') or '80' }}%
      - **SOC actuel** : {{ states('sensor.state_of_charge_last_known') }}%
      
      ### ‚ö° Heure de Branchement Recommand√©e
      
      | Puissance | Heure de Branchement | Dur√©e de Charge |
      |-----------|---------------------|-----------------|
      | **7.4 kW** | {{ states('sensor.bmw_ix3_charging_start_time_7_4kw') or 'Calcul...' }} | {{ states('sensor.bmw_ix3_charging_duration_7_4kw') or 'Calcul...' }} |
      | **11 kW** | {{ states('sensor.bmw_ix3_charging_start_time_11kw') or 'Calcul...' }} | {{ states('sensor.bmw_ix3_charging_duration_11kw') or 'Calcul...' }} |
      | **22 kW** | {{ states('sensor.bmw_ix3_charging_start_time_22kw') or 'Calcul...' }} | {{ states('sensor.bmw_ix3_charging_duration_22kw') or 'Calcul...' }} |
      
      ---
      
      ### üìä D√©tails du Calcul
      - **√ânergie √† charger** : {{ states('sensor.bmw_ix3_energy_to_charge') or 'Calcul...' }} kWh
      - **Temps de charge net** : {{ states('sensor.bmw_ix3_net_charging_time') or 'Calcul...' }}
      - **Marge de s√©curit√©** : +30 minutes
      
      ### üí° Recommandations
      - **Charge 7.4kW** : Id√©al pour la nuit (√©conomie + pr√©servation batterie)
      - **Charge 11kW** : Compromis vitesse/√©conomie
      - **Charge 22kW** : Charge rapide (si disponible)
      
      ---
      
      üîß **Note** : Les calculs sont automatiques et incluent la courbe de charge BMW iX3
    card_mod:
      style: |
        ha-card {
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
          border-radius: 15px;
        }
        ha-markdown {
          padding: 20px;
        }
        table {
          width: 100%;
          border-collapse: collapse;
          margin: 20px 0;
        }
        th, td {
          padding: 12px;
          text-align: center;
          border: 1px solid rgba(255,255,255,0.2);
        }
        th {
          font-weight: bold;
          background: rgba(156, 39, 176, 0.3);
          color: white;
        }
        td {
          background: rgba(255, 255, 255, 0.1);
          color: white;
        }
        h2 {
          color: #9C27B0;
          margin-top: 0;
        }
        h3 {
          color: #4CAF50;
          margin-top: 25px;
        }
  
  # Actions rapides
  - type: horizontal-stack
    cards:
      - type: custom:mushroom-template-card
        icon: mdi:clock-fast
        icon_color: green
        primary: D√©part 06h00
        secondary: Charge 7.4kW
        tap_action:
          action: call-service
          service: number.set_value
          service_data:
            entity_id: number.bmw_ix3_departure_time
            value: 6
        card_mod:
          style: |
            ha-card {
              background: rgba(76, 175, 80, 0.1);
              backdrop-filter: blur(10px);
            }
      - type: custom:mushroom-template-card
        icon: mdi:clock-outline
        icon_color: blue
        primary: D√©part 08h00
        secondary: Charge 11kW
        tap_action:
          action: call-service
          service: number.set_value
          service_data:
            entity_id: number.bmw_ix3_departure_time
            value: 8
        card_mod:
          style: |
            ha-card {
              background: rgba(33, 150, 243, 0.1);
              backdrop-filter: blur(10px);
            }
      - type: custom:mushroom-template-card
        icon: mdi:clock-alert
        icon_color: orange
        primary: D√©part 10h00
        secondary: Charge 22kW
        tap_action:
          action: call-service
          service: number.set_value
          service_data:
            entity_id: number.bmw_ix3_departure_time
            value: 10
        card_mod:
          style: |
            ha-card {
              background: rgba(255, 193, 7, 0.1);
              backdrop-filter: blur(10px);
            }
  
  # Statut de la planification
  - type: custom:mushroom-template-card
    primary: üìã Statut de la Planification
    secondary: |
      {% set departure = states('number.bmw_ix3_departure_time') | int %}
      {% set soc_target = states('sensor.target_state_of_charge') | int %}
      {% set soc_current = states('sensor.state_of_charge_last_known') | int %}
      
      {% if soc_current >= soc_target %}
        ‚úÖ SOC cible d√©j√† atteint ({{ soc_current }}% ‚â• {{ soc_target }}%)
      {% elif departure <= 6 %}
        ‚ö° Charge rapide recommand√©e (d√©part t√¥t)
      {% elif departure <= 8 %}
        üîã Charge standard recommand√©e (7.4kW)
      {% else %}
        üöÄ Charge lente possible (d√©part tardif)
      {% endif %}
    icon: mdi:check-circle
    icon_color: |
      {% set soc_target = states('sensor.target_state_of_charge') | int %}
      {% set soc_current = states('sensor.state_of_charge_last_known') | int %}
      {% if soc_current >= soc_target %}green
      {% else %}blue
      {% endif %}
    card_mod:
      style: |
        ha-card {
          background: rgba(76, 175, 80, 0.1);
          backdrop-filter: blur(10px);
          border-radius: 15px;
        }

# Style g√©n√©ral
card_mod:
  style: |
    ha-card {
      gap: 10px;
    }


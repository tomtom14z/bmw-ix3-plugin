# Automatisations pour le plugin BMW iX3

# Arr√™t automatique √† 80% pour prot√©ger la batterie
- id: bmw_ix3_auto_stop_80_percent
  alias: "BMW iX3 - Arr√™t auto √† 80%"
  description: "Arr√™te automatiquement la charge √† 80% pour prot√©ger la batterie"
  trigger:
    - platform: numeric_state
      entity_id: sensor.bmw_ix3_battery_level
      above: 79.5
      for:
        minutes: 1
  condition:
    - condition: state
      entity_id: switch.bmw_ix3_auto_stop_80_percent
      state: "on"
    - condition: state
      entity_id: sensor.bmw_ix3_charging_status
      state: "CHARGING"
  action:
    - service: switch.turn_off
      entity_id: switch.v2c_charging
    - service: notify.mobile_app_iphone
      data:
        title: "BMW iX3 - Protection batterie"
        message: "üîã Charge arr√™t√©e automatiquement √† 80% pour prot√©ger la batterie"
        data:
          notification_type: "auto_stop_80"

# Notification de d√©but de charge
- id: bmw_ix3_charging_start_notification
  alias: "BMW iX3 - Notification d√©but charge"
  description: "Envoie une notification quand la charge commence"
  trigger:
    - platform: state
      entity_id: sensor.bmw_ix3_charging_status
      from: "NOT_CHARGING"
      to: "CHARGING"
  action:
    - service: bmw_ix3_plugin.send_charging_notification
      data:
        notification_type: "charging_start"
        battery_level: "{{ states('sensor.bmw_ix3_battery_level') | float }}"
        charging_power: "{{ states('sensor.bmw_ix3_charging_power') | float }}"

# Notification √† 80% de charge
- id: bmw_ix3_charging_80_notification
  alias: "BMW iX3 - Notification 80%"
  description: "Envoie une notification quand la charge atteint 80%"
  trigger:
    - platform: numeric_state
      entity_id: sensor.bmw_ix3_battery_level
      above: 79.5
      for:
        minutes: 1
  condition:
    - condition: state
      entity_id: sensor.bmw_ix3_charging_status
      state: "CHARGING"
  action:
    - service: bmw_ix3_plugin.send_charging_notification
      data:
        notification_type: "charging_80"
        battery_level: "{{ states('sensor.bmw_ix3_battery_level') | float }}"
        charging_power: "{{ states('sensor.bmw_ix3_charging_power') | float }}"

# Notification de fin de charge (100%)
- id: bmw_ix3_charging_100_notification
  alias: "BMW iX3 - Notification 100%"
  description: "Envoie une notification quand la charge est termin√©e"
  trigger:
    - platform: state
      entity_id: sensor.bmw_ix3_charging_status
      to: "COMPLETE"
  action:
    - service: bmw_ix3_plugin.send_charging_notification
      data:
        notification_type: "charging_100"
        battery_level: "{{ states('sensor.bmw_ix3_battery_level') | float }}"

# Mise √† jour du widget iOS pendant la charge
- id: bmw_ix3_ios_widget_update_charging
  alias: "BMW iX3 - Mise √† jour widget iOS (charge)"
  description: "Met √† jour le widget iOS toutes les 5 minutes pendant la charge"
  trigger:
    - platform: time_pattern
      minutes: "/5"
  condition:
    - condition: state
      entity_id: sensor.bmw_ix3_charging_status
      state: "CHARGING"
  action:
    - service: bmw_ix3_plugin.update_ios_widget
      data:
        force_update: true

# Mise √† jour du widget iOS toutes les 15 minutes (hors charge)
- id: bmw_ix3_ios_widget_update_normal
  alias: "BMW iX3 - Mise √† jour widget iOS (normal)"
  description: "Met √† jour le widget iOS toutes les 15 minutes"
  trigger:
    - platform: time_pattern
      minutes: "/15"
  condition:
    - condition: state
      entity_id: sensor.bmw_ix3_charging_status
      state: "NOT_CHARGING"
  action:
    - service: bmw_ix3_plugin.update_ios_widget

# D√©marrage de charge programm√©
- id: bmw_ix3_scheduled_charging_start
  alias: "BMW iX3 - D√©marrage charge programm√©e"
  description: "D√©marre la charge √† l'heure programm√©e"
  trigger:
    - platform: time
      at: "{{ states('input_datetime.bmw_ix3_charging_start_time') }}"
  condition:
    - condition: state
      entity_id: sensor.bmw_ix3_charging_status
      state: "NOT_CHARGING"
    - condition: numeric_state
      entity_id: sensor.bmw_ix3_battery_level
      below: "{{ states('number.bmw_ix3_target_soc') | float - 5 }}"
  action:
    - service: switch.turn_on
      entity_id: switch.v2c_charging
    - service: notify.mobile_app_iphone
      data:
        title: "BMW iX3 - Charge programm√©e"
        message: "üöó D√©marrage de la charge programm√©e pour atteindre {{ states('number.bmw_ix3_target_soc') }}% √† {{ states('input_datetime.bmw_ix3_departure_time') }}"

# Arr√™t de charge programm√©
- id: bmw_ix3_scheduled_charging_stop
  alias: "BMW iX3 - Arr√™t charge programm√©e"
  description: "Arr√™te la charge √† l'heure programm√©e"
  trigger:
    - platform: time
      at: "{{ states('input_datetime.bmw_ix3_charging_stop_time') }}"
  condition:
    - condition: state
      entity_id: sensor.bmw_ix3_charging_status
      state: "CHARGING"
  action:
    - service: switch.turn_off
      entity_id: switch.v2c_charging
    - service: notify.mobile_app_iphone
      data:
        title: "BMW iX3 - Arr√™t programm√©"
        message: "‚èπÔ∏è Arr√™t de la charge programm√©e - Batterie √† {{ states('sensor.bmw_ix3_battery_level') }}%"

# Calcul automatique des heures de charge
- id: bmw_ix3_calculate_charging_times
  alias: "BMW iX3 - Calcul heures de charge"
  description: "Calcule automatiquement les heures de d√©but et fin de charge"
  trigger:
    - platform: state
      entity_id: input_datetime.bmw_ix3_departure_time
    - platform: state
      entity_id: number.bmw_ix3_target_soc
  action:
    - service: bmw_ix3_plugin.schedule_charging
      data:
        departure_time: "{{ states('input_datetime.bmw_ix3_departure_time') }}"
        target_soc: "{{ states('number.bmw_ix3_target_soc') | float }}"
        charging_power: "{{ states('sensor.bmw_ix3_charging_power') | float(7.4) }}"

